@page "/"
@rendermode InteractiveServer

<PageTitle>GeoBlazor Token Refresh Sample</PageTitle>

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">GeoBlazor Token Refresh Sample</h1>

            <!-- Documentation Section -->
            <div class="documentation-section mb-4">
                <p><strong>Token Authentication Process</strong></p>
                <p>
                    <strong>
                        This sample demonstrates how to implement automatic token refresh in GeoBlazor applications
                        using server-side authentication with ArcGIS Portal or ArcGIS Online.
                    </strong>
                    For end-to-end setup and guidance, see the GeoBlazor docs:
                    <a href="https://docs.geoblazor.com/pages/appTokenRefresh.html" target="_blank">
                        Token Refresh (App Authentication)
                    </a>.
                </p>

                <p><strong>1. Configuration Setup</strong></p>
                <p>
                    Configure your ArcGIS authentication settings in <code>appsettings.json</code> or user secrets:
                </p>

                <div class="alert alert-info">
                    <strong>Current Server Configuration:</strong>
                    <pre><code>@_currentConfig</code></pre>
                </div>

                <div class="alert alert-warning">
                    <strong>Portal vs ArcGIS Online Configuration</strong>
                    <ul>
                        <li><strong>ArcGIS Online:</strong> Set <code>ArcGISPortalUrl</code> to <code>https://www.arcgis.com</code> (or leave it empty to use the default). Do <em>not</em> add <code>/portal</code>.</li>
                        <li><strong>Enterprise Portal:</strong> Set <code>ArcGISPortalUrl</code> to your portal host. You may include or omit <code>/portal</code> — both are accepted and normalized. Examples: <code>https://your-server</code> or <code>https://your-server/portal</code>. Trailing slashes are optional.</li>
                    </ul>
                </div>

                <p><strong>2. Authentication Flow</strong></p>
                <p>
                    The authentication process involves two main components working together:
                </p>

                <p><strong>ArcGisAuthService.cs</strong></p>
                <ul>
                    <li>Makes HTTP requests to ArcGIS REST API</li>
                    <li>Handles client credentials flow</li>
                    <li>Caches tokens to local file</li>
                    <li>Manages token expiration</li>
                </ul>

                <p><strong>AuthenticationManager.cs/.ts</strong></p>
                <ul>
                    <li>C# wrapper around TypeScript implementation</li>
                    <li>Integrates with ArcGIS Maps SDK for JavaScript</li>
                    <li>Registers tokens with ArcGIS Identity Manager</li>
                    <li>Provides authentication state management</li>
                </ul>
            </div>

            <div class="alert alert-primary">
                <strong>Ready to Test?</strong>
                <p class="mb-2">Choose which render mode demonstration you'd like to see:</p>
                <div class="row">
                    <div class="col-md-6">
                        <div class="card border-primary">
                            <div class="card-body">
                                <h6 class="card-title">🖥️ InteractiveServer Mode</h6>
                                <p class="card-text small">Server-side execution over SignalR. Best for fast first render and secure token handling.</p>
                                <a href="/map-server" class="btn btn-primary btn-sm">View Server Mode Demo</a>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card border-success">
                            <div class="card-body">
                                <h6 class="card-title">💻 InteractiveWebAssembly Mode</h6>
                                <p class="card-text small">Pure client-side execution. Best for rich interactivity and offline capability.</p>
                                <a href="/map-webassembly" class="btn btn-success btn-sm">View WebAssembly Demo</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div>
                <p>
                    Once your tokens are configured and working, navigate to the <strong>Map</strong> page
                    to see the fully authenticated GeoBlazor map in action!
                </p>
                <ul>
                    <li>Automatic token refresh keeps your map sessions active</li>
                    <li>Secure server-side authentication protects your credentials</li>
                    <li>Seamless integration with ArcGIS Portal or ArcGIS Online</li>
                </ul>
                <p>
                    Ready to learn more? Check out the <a href="https://docs.geoblazor.com" target="_blank">GeoBlazor documentation</a>
                    and <a href="https://samples.geoblazor.com" target="_blank">samples</a> to unlock more possibilities!
                </p>
            </div>
        </div>
    </div>
</div>

@code {
    private string _currentConfig = "";

    protected override void OnInitialized()
    {
        // Show the template configuration as it appears in the sample appsettings.json
        var configLines = new List<string>
        {
            "{",
            "  \"Logging\": {",
            "    \"LogLevel\": {",
            "      \"Default\": \"Information\",",
            "      \"Microsoft.AspNetCore\": \"Warning\"",
            "    }",
            "  },",
            "  \"ArcGISAppId\": \"Your_ARCGIS_APP_ID\",",
            "  \"ArcGISClientSecret\": \"Your_ARCGIS_CLIENT_SECRET\",",
            "  \"ArcGISPortalUrl\": \"https://your-portal-url/portal/\",",
            "  \"ArcGISAppTokenCacheFile\": \"arcgis_token_cache-file-name.json\",",
            "  \"ArcGISTokenExpirationMinutes\": \"1440\",",
            "  \"GeoBlazor\": {",
            "    \"RegistrationKey\": \"YOUR_GEO_BLAZOR_REGISTRATION_KEY\"",
            "  }",
            "}"
        };
        _currentConfig = string.Join("\n", configLines);
    }
}
