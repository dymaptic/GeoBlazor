@inherits TestRunnerBase

@{
    base.BuildRenderTree(__builder);
}

@code {

    [TestMethod]
    public async Task TestCanRenderSearchWidget(Action renderHandler)
    {
        AddMapRenderFragment(
            @<MapView class="map-view" OnViewRendered="renderHandler">

                <Map>
                    <Basemap>
                        <BasemapStyle Name="BasemapStyleName.ArcgisImagery" />
                    </Basemap>
                </Map>
                <SearchWidget />

            </MapView>);

        await WaitForMapToRender();
        await AssertJavaScript("assertWidgetExists", args: "esri.widgets.Search");
    }

    [TestMethod]
    public async Task TestSearchWidgetGetResultsHandler(Action renderHandler)
    {
        SearchWidget? widget = null;
        var resultsHandlerWasCalled = false;

        Task<IReadOnlyList<SearchResult>> GetResultsHandler(bool? exactMatch, Point? location, int? maxResults,
            int? sourceIndex, SpatialReference? spatialReference, SuggestResult suggestResult, Guid? viewId)
        {
            Assert.IsNotNull(viewId);
            resultsHandlerWasCalled = true;

            return Task.FromResult<IReadOnlyList<SearchResult>>(new List<SearchResult>());
        }

        AddMapRenderFragment(
            @<MapView class="map-view" OnViewRendered="renderHandler">

                <Map>
                    <Basemap>
                        <BasemapStyle Name="BasemapStyleName.ArcgisImagery" />
                    </Basemap>
                </Map>
                <SearchWidget @ref="widget">
                    <LocatorSearchSource Url="https://geocode-api.arcgis.com/arcgis/rest/services/World/GeocodeServer"
                                         GetResultsHandler="GetResultsHandler" />
                </SearchWidget>

            </MapView>);

        await WaitForMapToRender();
        await Task.Delay(1000);
        await AssertJavaScript("assertWidgetExists", args: "esri.widgets.Search");
        await widget!.Search("test");
        await WaitForMapToRender();
        await Task.Delay(1000);
        Assert.IsTrue(resultsHandlerWasCalled);
    }

    [TestMethod]
    public async Task TestSearchWidgetGetSuggestionsHandler(Action renderHandler)
    {
        var suggestionsHandlerWasCalled = false;

        Task<IReadOnlyList<SuggestResult>> GetSuggestionsHandler(int? maxSuggestions, int? sourceIndex,
            SpatialReference? spatialReference, string? suggestTerm, Guid? viewId)
        {
            Assert.IsNotNull(viewId);
            suggestionsHandlerWasCalled = true;

            return Task.FromResult<IReadOnlyList<SuggestResult>>(new List<SuggestResult>());
        }

        AddMapRenderFragment(
            @<MapView class="map-view" OnViewRendered="renderHandler">

                <Map>
                    <Basemap>
                        <BasemapStyle Name="BasemapStyleName.ArcgisImagery" />
                    </Basemap>
                </Map>
                <SearchWidget>
                    <LocatorSearchSource Url="https://geocode-api.arcgis.com/arcgis/rest/services/World/GeocodeServer"
                                         GetSuggestionsHandler="GetSuggestionsHandler" />
                </SearchWidget>

            </MapView>);

        await WaitForMapToRender();
        await AssertJavaScript("assertWidgetExists", args: "esri.widgets.Search");
        await AssertJavaScript("triggerSearchHandlers");

        var tries = 50;

        while (!suggestionsHandlerWasCalled && (tries > 0))
        {
            await Task.Delay(100);
            tries--;
        }

        Assert.IsTrue(suggestionsHandlerWasCalled);
    }

    [TestMethod]
    public async Task TestSearchWidgetMethods(Action renderHandler)
    {
        SearchWidget? widget = null;

        AddMapRenderFragment(
            @<MapView class="map-view" OnViewRendered="renderHandler">

                <Map>
                    <Basemap>
                        <BasemapStyle Name="BasemapStyleName.ArcgisImagery" />
                    </Basemap>
                </Map>
                <SearchWidget @ref="widget" />

            </MapView>);

        await WaitForMapToRender();
        await AssertJavaScript("assertWidgetExists", args: "esri.widgets.Search");
        await widget!.SetSearchTerm("testSearchTerm");
        string? searchTerm = await widget.GetSearchTerm();
        Assert.AreEqual("testSearchTerm", searchTerm);
        SuggestResponse suggestResponse = await widget!.Suggest("test");
        Assert.IsNotNull(suggestResponse);
        SearchResponse searchResponse = await widget!.Search("test");
        Assert.IsNotNull(searchResponse);
        IReadOnlyList<SearchResultResponse>? searchResultResponse = await widget.GetResults();
        Assert.IsNotNull(searchResultResponse);
        IReadOnlyList<SuggestResult>? suggestResults = await widget.GetSuggestions();
        Assert.IsNotNull(suggestResults);
        SearchMenu? activeMenu = await widget.GetActiveMenu();
        Assert.IsNotNull(activeMenu);
        SearchSource? activeSource = await widget.GetActiveSource();
        Assert.IsNotNull(activeSource);
        int? activeSourceIndex = await widget.GetActiveSourceIndex();
        Assert.AreEqual(0, activeSourceIndex);
        IReadOnlyList<SearchSource> allSources = (await widget.GetAllSources())!;
        Assert.AreEqual(1, allSources.Count);
        IReadOnlyList<SearchSource> defaultSources = (await widget.GetDefaultSources())!;
        Assert.AreEqual(1, defaultSources.Count);
        Graphic resultGraphic = (await widget.GetResultGraphic())!;
        Assert.IsNotNull(resultGraphic);
        SearchResult selectedResult = await widget.GetSelectedResult();
        Assert.IsNotNull(selectedResult);
    }

    [TestMethod]
    public async Task TestSearchWidgetOnSearchCompleteEvent(Action renderHandler)
    {
        SearchWidget? widget = null;
        SearchCompleteEvent? receivedEvent = null;
        var eventReceived = false;

        void OnSearchComplete(SearchCompleteEvent evt)
        {
            receivedEvent = evt;
            eventReceived = true;
        }

        AddMapRenderFragment(
            @<MapView class="map-view" OnViewRendered="renderHandler">

                <Map>
                    <Basemap>
                        <BasemapStyle Name="BasemapStyleName.ArcgisImagery" />
                    </Basemap>
                </Map>
                <SearchWidget @ref="widget" OnSearchComplete="OnSearchComplete" />

            </MapView>);

        await WaitForMapToRender();
        await AssertJavaScript("assertWidgetExists", args: "esri.widgets.Search");

        // Perform a search that should trigger the event
        await widget!.Search("New York");

        // Wait for the event to be received
        var tries = 50;
        while (!eventReceived && tries > 0)
        {
            await Task.Delay(100);
            tries--;
        }

        Assert.IsTrue(eventReceived, "OnSearchComplete event was not received");
        Assert.IsNotNull(receivedEvent);
        Assert.IsNotNull(receivedEvent.SearchTerm);
        Assert.AreEqual("New York", receivedEvent.SearchTerm);
    }

    [TestMethod]
    public async Task TestSearchWidgetOnSearchCompleteEventHasResults(Action renderHandler)
    {
        SearchWidget? widget = null;
        SearchCompleteEvent? receivedEvent = null;
        var eventReceived = false;

        void OnSearchComplete(SearchCompleteEvent evt)
        {
            receivedEvent = evt;
            eventReceived = true;
        }

        AddMapRenderFragment(
            @<MapView class="map-view" OnViewRendered="renderHandler">

                <Map>
                    <Basemap>
                        <BasemapStyle Name="BasemapStyleName.ArcgisImagery" />
                    </Basemap>
                </Map>
                <SearchWidget @ref="widget" OnSearchComplete="OnSearchComplete" />

            </MapView>);

        await WaitForMapToRender();
        await AssertJavaScript("assertWidgetExists", args: "esri.widgets.Search");

        // Perform a search that should return results
        await widget!.Search("Redlands, CA");

        // Wait for the event to be received
        var tries = 50;
        while (!eventReceived && tries > 0)
        {
            await Task.Delay(100);
            tries--;
        }

        Assert.IsTrue(eventReceived, "OnSearchComplete event was not received");
        Assert.IsNotNull(receivedEvent);
        Assert.IsNotNull(receivedEvent.Results, "Results should not be null");
        Assert.IsTrue(receivedEvent.Results.Count > 0, "Results should contain at least one result group");

        // Verify the first result group has results with proper values
        var firstResultGroup = receivedEvent.Results.First();
        Assert.IsNotNull(firstResultGroup.Results, "First result group should have results");
        Assert.IsTrue(firstResultGroup.Results.Count > 0, "First result group should contain at least one result");

        // Verify the search result has the expected properties populated
        var firstResult = firstResultGroup.Results.First();
        Assert.IsNotNull(firstResult.Name, "Result should have a name");
        Assert.IsNotNull(firstResult.Feature, "Result should have a feature graphic");
        Assert.IsNotNull(firstResult.Extent, "Result should have an extent");
    }

    [TestMethod]
    public async Task TestSearchWidgetOnSelectResultEvent(Action renderHandler)
    {
        SearchWidget? widget = null;
        SearchSelectResultEvent? receivedEvent = null;
        var eventReceived = false;

        void OnSelectResult(SearchSelectResultEvent evt)
        {
            receivedEvent = evt;
            eventReceived = true;
        }

        AddMapRenderFragment(
            @<MapView class="map-view" OnViewRendered="renderHandler">

                <Map>
                    <Basemap>
                        <BasemapStyle Name="BasemapStyleName.ArcgisImagery" />
                    </Basemap>
                </Map>
                <SearchWidget @ref="widget" OnSelectResult="OnSelectResult" />

            </MapView>);

        await WaitForMapToRender();
        await AssertJavaScript("assertWidgetExists", args: "esri.widgets.Search");

        // Perform a search - this should automatically select the first result (AutoSelect=true by default)
        await widget!.Search("Redlands, CA");

        // Wait for the event to be received
        var tries = 50;
        while (!eventReceived && tries > 0)
        {
            await Task.Delay(100);
            tries--;
        }

        Assert.IsTrue(eventReceived, "OnSelectResult event was not received");
        Assert.IsNotNull(receivedEvent);
        Assert.IsNotNull(receivedEvent.Result, "Result should not be null");
        Assert.IsNotNull(receivedEvent.Result.Name, "Result should have a name");
        Assert.IsNotNull(receivedEvent.Result.Feature, "Result should have a feature graphic");
        Assert.IsNotNull(receivedEvent.Result.Extent, "Result should have an extent");
        Assert.IsNotNull(receivedEvent.Source, "Source should not be null");
        Assert.IsNotNull(receivedEvent.SourceIndex, "SourceIndex should not be null");
    }

    [TestMethod]
    public async Task TestSearchWidgetOnSelectResultEventFeatureHasGeometry(Action renderHandler)
    {
        SearchWidget? widget = null;
        SearchSelectResultEvent? receivedEvent = null;
        var eventReceived = false;

        void OnSelectResult(SearchSelectResultEvent evt)
        {
            receivedEvent = evt;
            eventReceived = true;
        }

        AddMapRenderFragment(
            @<MapView class="map-view" OnViewRendered="renderHandler">

                <Map>
                    <Basemap>
                        <BasemapStyle Name="BasemapStyleName.ArcgisImagery" />
                    </Basemap>
                </Map>
                <SearchWidget @ref="widget" OnSelectResult="OnSelectResult" />

            </MapView>);

        await WaitForMapToRender();
        await AssertJavaScript("assertWidgetExists", args: "esri.widgets.Search");

        // Search for a well-known location
        await widget!.Search("Statue of Liberty, NY");

        // Wait for the event to be received
        var tries = 50;
        while (!eventReceived && tries > 0)
        {
            await Task.Delay(100);
            tries--;
        }

        Assert.IsTrue(eventReceived, "OnSelectResult event was not received");
        Assert.IsNotNull(receivedEvent);
        Assert.IsNotNull(receivedEvent.Result, "Result should not be null");
        Assert.IsNotNull(receivedEvent.Result.Feature, "Result should have a feature");
        Assert.IsNotNull(receivedEvent.Result.Feature.Geometry, "Feature should have geometry");

        // Verify the extent has valid coordinates (Extent properties are non-nullable doubles)
        Assert.IsNotNull(receivedEvent.Result.Extent, "Result should have an extent");
        // Verify the extent has reasonable coordinate values (not default 0 for all)
        var extent = receivedEvent.Result.Extent;
        Assert.IsTrue(extent.Xmin != 0 || extent.Xmax != 0 || extent.Ymin != 0 || extent.Ymax != 0,
            "Extent should have at least one non-zero coordinate value");
    }

    [TestMethod]
    public async Task TestSearchWidgetBothEventsFireOnSearch(Action renderHandler)
    {
        SearchWidget? widget = null;
        var searchCompleteReceived = false;
        var selectResultReceived = false;
        SearchCompleteEvent? searchCompleteEvent = null;
        SearchSelectResultEvent? selectResultEvent = null;

        void OnSearchComplete(SearchCompleteEvent evt)
        {
            searchCompleteEvent = evt;
            searchCompleteReceived = true;
        }

        void OnSelectResult(SearchSelectResultEvent evt)
        {
            selectResultEvent = evt;
            selectResultReceived = true;
        }

        AddMapRenderFragment(
            @<MapView class="map-view" OnViewRendered="renderHandler">

                <Map>
                    <Basemap>
                        <BasemapStyle Name="BasemapStyleName.ArcgisImagery" />
                    </Basemap>
                </Map>
                <SearchWidget @ref="widget"
                              OnSearchComplete="OnSearchComplete"
                              OnSelectResult="OnSelectResult" />

            </MapView>);

        await WaitForMapToRender();
        await AssertJavaScript("assertWidgetExists", args: "esri.widgets.Search");

        // Perform a search
        await widget!.Search("San Francisco, CA");

        // Wait for both events to be received
        var tries = 50;
        while ((!searchCompleteReceived || !selectResultReceived) && tries > 0)
        {
            await Task.Delay(100);
            tries--;
        }

        Assert.IsTrue(searchCompleteReceived, "OnSearchComplete event was not received");
        Assert.IsTrue(selectResultReceived, "OnSelectResult event was not received");

        // Verify both events have data
        Assert.IsNotNull(searchCompleteEvent);
        Assert.IsNotNull(searchCompleteEvent.Results);
        Assert.IsNotNull(selectResultEvent);
        Assert.IsNotNull(selectResultEvent.Result);
    }
}